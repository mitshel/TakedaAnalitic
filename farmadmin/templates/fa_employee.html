{% extends "fa_layout.html" %}
{% load staticfiles %}
{% load i18n %}

{% block page %}
<style>
table.datatable tr {
    font-size: 0.9rem;
    font-weight: 400;
    line-height: 0.9rem;
}

.rowGrayed {
    background-color: #a9a9a9; !important;
    font-style: italic;
}

</style>

<div class="container-fluid px-4">
<div class="row">
<div class="col-12">

<div class="row">
      <div class="form-group col-lg-3 col-md-4 col-sm-6">
        <label for="nameInput">Сотрудник</label>
        <input type="text" class="form-control" id="nameInput" placeholder="" value="{{ object.name }}">
      </div>

      <div class="form-group col-lg-3 col-md-4 col-sm-6">
        <label for="parentSelect">Руководитель</label>
        <select class="form-control" id="parentSelect">
           {% for p in parents %}
               <option {% if p == object.parent %}selected{% endif %}>{{ p.name }}</option>
           {% endfor %}
        </select>
      </div>
</div>
<div class="row">
      <div class="form-group col-lg-3 col-md-4 col-sm-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="isTarget" {% if object.istarget %}checked{% endif %}>
          <label class="form-check-label" for="isTarget">
            Показывать как таргет
          </label>
        </div>
      </div>
</div>
<br>
<b>ГРУЗОПОЛУЧАТЕЛИ:</b><br>
<div class="row" style="background-color: #E5E5F5">
    <div class="col-lg-6 col-sm-12 pt-4">

        <div class="row">
            <div class="col-6">
                 <div class="input-group input-group-sm mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">Поиск</span>
                  </div>
                  <input type="text" class="form-control" id="searchLpuAll" placeholder="" aria-label="Search" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-6">

                <button type="button" class="btn btn-outline-primary btn-sm"><i class="fa fa-list"></i> ИНН</button>
                <div class="float-right">
                    <button type="button" id="lpua-ctrl" class="btn btn-sm btn-outline-primary inline btn-srv" data-toggle="button" aria-pressed="false" autocomplete="off" title="Мультивыбор"><i class="fa fa-list"></i></button>
                    <button type="button" id="lpua-check" class="btn btn-sm btn-outline-primary inline btn-srv btn-filter" title="Выбрать/отменить все"><i class="fa fa-check"></i></button>
                    <button type="button" class="btn btn-outline-primary btn-sm"  id="addLpu">Добавить ЛПУ&nbsp;&nbsp;<i class="fa fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

         <div class="row">
            <div class="col-12">
                <table id="tblLpuAll" class="table datatable table-hover table-sm display w-100"></table>
            </div>
         </div>

    </div>

    <div class="col-lg-6 col-sm-12 pt-4">

        <div class="row">
            <div class="col-6">
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="removeLpu"><i class="fa fa-arrow-left"></i>&nbsp;&nbsp;Удалить ЛПУ</button>
                    <button type="button" id="lpue-check" class="btn btn-sm btn-outline-primary inline btn-srv btn-filter" title="Выбрать/отменить все"><i class="fa fa-check"></i></button>
                    <button type="button" id="lpue-ctrl" class="btn btn-sm btn-outline-primary inline btn-srv" data-toggle="button" aria-pressed="false" autocomplete="off" title="Мультивыбор"><i class="fa fa-list"></i></button>
                </div>
            </div>

            <div class="col-6">
                 <div class="input-group input-group-sm mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">Поиск</span>
                  </div>
                  <input type="text" class="form-control" id="searchLpuEmp" placeholder="" aria-label="Search" aria-describedby="basic-addon1">
                </div>
            </div>
        </div>

         <div class="row">
            <div class="col-12">
                <table id="tblLpuEmp" class="table datatable table-hover table-sm display w-100"></table>
            </div>
         </div>

    </div>


</div>

    <br>
    <b>ПРИВЯЗАННЫЕ АККАУНТЫ:</b><br>
    {% for u in object.users.all %}
        {{ u.username }} <br>
    {% endfor %}
</div>
</div>
</div>

<script>

$(document).ready(function() {
    var LpuA_selectAll = 0;
    var LpuE_selectAll = 0;
    var LpuA_selected = [];
    var LpuE_selected = [];

    var dsLpuEmp = [
        {%  for l in lpu %}
            { 'cust_id': '{{ l.cust_id }}', 'inn': '{{ l.inn }}', 'name': '{{ l.name }}' }{% if not forloop.last %}, {% endif %}
        {% endfor %}
    ];
    var tblLpuEmp = $('#tblLpuEmp').DataTable( {
        dom: '<"row"<"col-12"t>><"row"<"col-12"p><"col-12"i>>',
        //select: { style: 'multi' },
        select: { style: 'api' },
        ordering:  true,
        order: [[ 2, "asc" ]],
        scrollY: "300px",
        scrollX: false,
        scrollCollapse: true,
        deferRender: true,
        scroller: { loadingIndicator: true },
        paging: true,
        //"columnDefs": [
        //            { title: "id", name: "cust_id", "targets": 0 , "visible": false, "searchable": false },
        //            { title: "ИНН", name: "inn", "targets": 1, "visible": true, "searchable": true },
        //            { title: "ЛПУ", name: "name", "targets": 2, "visible": true, "searchable": true },
        //],
        columns: [
                    { "title": "id",  "data": "cust_id", "visible": false, "searchable": false },
                    { "title": "ИНН", "data": "inn", "visible": true, "searchable": true },
                    { "title": "ЛПУ", "data": "name", "visible": true, "searchable": true },
        ],
        data: dsLpuEmp,
        rowCallback: function(row, data){
            if ( $.inArray(data[0], LpuE_selected) !== -1 ) {
                if (LpuE_selectAll) $(row).removeClass('selected');
                else $(row).addClass('selected');
            } else {
                 if (LpuE_selectAll) $(row).addClass('selected');
                else $(row).removeClass('selected');
            }
        },
        //"processing": true,
        //"serverSide": true,
        //"stateSave" : true,
        //"ajax": {
        //    "url": "{ % url 'farmadmin:jlpuemp' %}",
        //    "type": "POST",
        //    "data": function ( d ) {
        //        d.employee = '{{ object.id }}';
        //        d.csrfmiddlewaretoken = '{{ csrf_token }}';
        //    }
        //},
        language: lang_russian
    } );

    $("#searchLpuEmp").keyup(function(){
        tblLpuEmp.search( this.value ).draw();
    });

    var tblLpuAll = $('#tblLpuAll').DataTable( {
        dom: '<"row"<"col-12"t>><"row"<"col-12"p><"col-12"i>>',
        //select: { style: 'multi' },
        select: { style: 'api' },
        ordering:  false,
        scrollY: "300px",
        scrollX: false,
        scrollCollapse: true,
        deferRender: true,
        scroller: { loadingIndicator: true },
        paging: true,
        "columnDefs": [
                    { title: "id", name: "cust_id", "targets": 0 , "visible": false, "searchable": false },
                    { title: "ИНН", name: "inn", "targets": 1, "visible": true, "searchable": true },
                    { title: "ЛПУ", name: "name", "targets": 2, "visible": true, "searchable": true },
        ],
        rowCallback: function(row, data){
            var fnd = tblLpuEmp.column( 0 ).data().toArray().indexOf(data[0])>=0;
            if (fnd) $(row).addClass("rowGrayed");

            if ( $.inArray(data[0], LpuA_selected) !== -1 ) {
                if (LpuA_selectAll) $(row).removeClass('selected');
                else $(row).addClass('selected');
            } else {
                 if (LpuA_selectAll) $(row).addClass('selected');
                else $(row).removeClass('selected');
            }
        },
        "processing": true,
        "serverSide": true,
        //"stateSave" : true,
        "ajax": {
            "url": "{% url 'farmadmin:jlpuall' %}",
            "type": "POST",
            "data": function ( d ) {
                d.employee = '{{ object.id }}';
                d.csrfmiddlewaretoken = '{{ csrf_token }}';
            }
        },
        language: lang_russian
    } );

    $("#searchLpuAll").keyup(function(){
        tblLpuAll.search( this.value ).draw();
    });

    //$("#addLpu").on( 'click', function () {
    //    var rows_selected = tblLpuAll.rows('.selected').data();
    //    $.each(rows_selected,function(i,v){
    //        var fnd = tblLpuEmp.column( 0 ).data().toArray().indexOf(v[0])>=0;
    //        if (!fnd)
    //            tblLpuEmp.row.add( {'cust_id':v[0],'inn':v[1],'name':v[2]} ).draw();
    //    });
    //    tblLpuAll.rows('.selected').deselect().draw();
    //});

    $("#addLpu").on( 'click', function () {
        if (LpuA_selectAll) {
        }
        else {
        };
        var rows_selected = tblLpuAll.rows('.selected').data();
        $.each(rows_selected,function(i,v){
            var fnd = tblLpuEmp.column( 0 ).data().toArray().indexOf(v[0])>=0;
            if (!fnd)
                tblLpuEmp.row.add( {'cust_id':v[0],'inn':v[1],'name':v[2]} ).draw();
        });
        tblLpuAll.rows('.selected').deselect().draw();
    });

    $("#removeLpu").on( 'click', function () {
       tblLpuEmp.rows('.selected').remove().draw();
       tblLpuAll.draw();
    });

// Выделяет всю таблицу либо сбрасывает ее выделение
function LpuA_check( mode ) {
    if (mode) {
        tblLpuAll.rows().select();
        LpuA_selectAll = 1;
        $('#lpua-check').addClass('active');
    }
    else {
        tblLpuAll.rows().deselect();
        LpuA_selectAll = 0;
        $('#lpua-check').removeClass('active');
    }
    // чистим массив с идентификаторами выделенных/не выделенных строк
    LpuA_selected.length = 0;
}

function LpuE_check( mode ) {
    if (mode) {
        tblLpuEmp.rows().select();
        LpuE_selectAll = 1;
        $('#lpue-check').addClass('active');
    }
    else {
        tblLpuEmp.rows().deselect();
        LpuE_selectAll = 0;
        $('#lpue-check').removeClass('active');
    }
    // чистим массив с идентификаторами выделенных/не выделенных строк
    LpuE_selected.length = 0;
}

$('#lpua-check').on('click', function () {
    // При нажатии на кнопку Выбрать ВСЕ - выделяем или снимаем выделение со всех ЛПУ
    LpuA_check( !$('#lpua-check').hasClass('active') );
});

$('#lpue-check').on('click', function () {
    // При нажатии на кнопку Выбрать ВСЕ - выделяем или снимаем выделение со всех ЛПУ
    LpuE_check( !$('#lpue-check').hasClass('active') );
});

$('#tblLpuAll tbody').on('click', 'tr', function (event) {
    var id = tblLpuAll.row(this).data()[0];
    var ctrlPress = (event.ctrlKey == true);

    // Если не включен мультивыбор сначала сбрасываем все выбор
    if ((!ctrlPress) & (!$('#lpua-ctrl').hasClass('active'))) {
        LpuA_check(0);
    }

    var thisSelected = $(this).hasClass('selected');

    // Ищем наш элемент в массиве запомненных selected/deselected элементов
    var index = $.inArray(id, LpuA_selected);

    if (thisSelected & LpuA_selectAll) {
        // делаем деселект и добавляем в массив selected (который сейчас какбы массив deselected)
        $(this).removeClass('selected');
        if ( index === -1 ) LpuA_selected.push( id );
    }

    if (thisSelected & !LpuA_selectAll) {
        // делаем деселект и удаляем из массива selected
        $(this).removeClass('selected');
        if ( index !== -1 ) LpuA_selected.splice( index, 1 );
    }

    if (!thisSelected & LpuA_selectAll) {
        // делаем селект и удаляем из массива selected (который сейчас какбы массив deselected)
        $(this).addClass('selected');
        if ( index !== -1 ) LpuA_selected.splice( index, 1 );
    }

    if (!thisSelected & !LpuA_selectAll) {
        // делаем селект и добавляем в массив selected
        $(this).addClass('selected');
        if ( index === -1 ) LpuA_selected.push( id );
    }

} );

$('#tblLpuEmp tbody').on('click', 'tr', function (event) {
    var id = tblLpuEmp.row(this).data()[0];
    var ctrlPress = (event.ctrlKey == true);

    // Если не включен мультивыбор сначала сбрасываем все выбор
    if ((!ctrlPress) & (!$('#lpue-ctrl').hasClass('active'))) {
        LpuE_check(0);
    }

    var thisSelected = $(this).hasClass('selected');

    // Ищем наш элемент в массиве запомненных selected/deselected элементов
    var index = $.inArray(id, LpuE_selected);

    if (thisSelected & LpuE_selectAll) {
        // делаем деселект и добавляем в массив selected (который сейчас какбы массив deselected)
        $(this).removeClass('selected');
        if ( index === -1 ) LpuE_selected.push( id );
    }

    if (thisSelected & !LpuE_selectAll) {
        // делаем деселект и удаляем из массива selected
        $(this).removeClass('selected');
        if ( index !== -1 ) LpuE_selected.splice( index, 1 );
    }

    if (!thisSelected & LpuE_selectAll) {
        // делаем селект и удаляем из массива selected (который сейчас какбы массив deselected)
        $(this).addClass('selected');
        if ( index !== -1 ) LpuE_selected.splice( index, 1 );
    }

    if (!thisSelected & !LpuE_selectAll) {
        // делаем селект и добавляем в массив selected
        $(this).addClass('selected');
        if ( index === -1 ) LpuE_selected.push( id );
    }

} );

} );

</script>

{% endblock %}