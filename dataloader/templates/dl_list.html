<div class="modal fade" tabindex="-1" role="dialog" id="modalFilterSave">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Сохранение фильтра</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="form-group">
            <label for="inputFilterName">Введите имя фильтра для сохранения</label>
            <input type="text" class="form-control" id="inputFilterName" aria-describedby="filterHelp" placeholder="Фильтр" autocomplete="False">
            <small id="filterHelp" class="form-text text-muted">Введите наименование фильтра, чтобы отличить его от других в Вашей таблице сохраненных фильтров.</small>
          </div>
          <input type="hidden" id="saveConfirmId" value="0">
          <input type="hidden" id="savenConfirmType" value="1">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-primary" id="btn_filter_save">Сохранить фильтр</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" role="dialog" id="modalDeleteConfirm">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Подтверждение операции</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <p style="text-align: center">
              Вы уверены, что хотите удалить фильтр<br>
             <b>"<span id="operationConfirmFilterName"></span>"</b>
          </p>
          <input type="hidden" id="operationConfirmId" value="0">
          <input type="hidden" id="operationConfirmType" value="1">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal" id="buttonOperationConfirmed">Удалить</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
 <div class="col-12">
     <div class="card ml-1 mr-1">
         <h6 class="card-header pt-1 pb-1" style="background-color: #ddddff;"><b>УПРАВЛЕНИЕ ЗАГРУЗКАМИ</b></h6>
         <div class="card-body p-1">
            <div class="col-12">
                <br>
                <table class="table table-sm table-hover display w-100 datatable display" width="100%" id="ta_flt_table">
                <thead class="thead-light">
                    <tr>
                        <th>Имя фильтра</th>
                        <th>Дата создания</th>
                        <th>Операции</th>
                    </tr>
                </thead>
                </table>
            </div>
         </div>
         <div class="card-footer pl-1">
            <div class="col-12">
                 <a class="btn btn-primary" href="#" role="button" id="data_load_button"><i class="fa fa-table"></i> Загрузить данные</a>
                 <a class="btn btn-primary" href="#" role="button" id="data_save_button"><i class="fa fa-check"></i> Сохранить фильтр</a>
                 <a class="btn btn-danger" href="#" role="button" id="data_clear_button"><i class="fa fa-times"></i> Сбросить фильтр</a>
            </div>
         </div>
     </div>
 </div>
 </div>

<script type="text/javascript">

     var ta_flt_table = $('#ta_flt_table').DataTable({
                    "dom": 'r<"row col-12"<f><l><B>> <"col-12 p-0"t> <"row"<"col-6"i><"col-6"p>>',
                    select: true,
                    buttons: [],
                    "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                    "pageLength": 10,
                    "columnDefs": [
                        { "name": "name", "targets": 0, "visible": true, "searchable": true },
                        { "name": "created", "targets": 1, "visible": true, "searchable": false,
                            "render": function (data) { return data; },
                        },
                        { "name": "id", "targets": 2, "visible": true, "searchable": false,
                            "render": function (data, type, row, meta) {
                                            data_suffix = " data-id='" + data + "' data-filtername='"+row[0]+"'></i>"
                                            delete_icon = "<i class='far fa-trash-alt t1' style='color:red;cursor:pointer' title='Удалить фильтр' " + data_suffix;
                                            edit_icon = "<i class='far fa-edit t2' style='color:blue;cursor:pointer' title='Изменить имя фильтра' " + data_suffix;
                                            sync_icon = "<i class='fa fa-sync t3' style='color:blue;cursor:pointer' title='Загрузить фильтры'" + data_suffix;
                                            spinner_icon = "<i class='fas fa-spinner fa-spin t4' style='color:green;cursor:pointer' title='Сформировать Excel'" + data_suffix;
                                            calendar_icon = "<i class='far fa-calendar-alt t4' style='color:gray;cursor:pointer' title='Расписание формирования данных'" + data_suffix;
                                            excel_icon = "<i class='far fa-file-excel t4' style='color:gray;cursor:pointer' title='Скачать Excel'" + data_suffix;
                                            icons =  delete_icon + '&nbsp;' + edit_icon + '&nbsp;' + sync_icon + '&nbsp;' + calendar_icon + '&nbsp;' + spinner_icon + '&nbsp;' + excel_icon;
                                            return icons;
                                      },
                        }
                    ],
                    "processing": true,
                    "serverSide": true,
                    "ordering":  true,
                    "order": [[ 0, 1 ]],
                    "ajax": {
                        "url": "{% url 'data:filters' %}",
                        "type": "POST",
                        "data": function ( d ) {
                            d.csrfmiddlewaretoken = '{{ csrf_token }}';
                        },
                        //"success": function(data) { console.log(data); }
                    },
                    "language": lang_russian
                });

     var query_dict = {};
     var fields_arr = [];

     function make_request_data () {
        query_dict = {};
        fields_arr = [];
        for (var idx in all_fields) {
            f = all_fields[idx];
            if ($('#' + f + '_check').hasClass('active')) fields_arr.push(f);
            if ($('#' + f + '_filter').hasClass('active')) {
               var cnt = 0;
               var filters = [];
               if (f in flt_counts) {
                   cnt = flt_counts[f];
               };

               for (var i=0; i<cnt; i++) {
                   var element = [];
                   op_id = 'selector-btn-' + f + '-' + i;
                   inp_id = 'input-' + f + '-' + i;
                   add_id = 'add-' + f + '-' + i;

                   if ($('#'+op_id)) element.push($('#'+op_id).attr("action"));
                   if ($('#'+inp_id)) element.push($('#'+inp_id).val());
                   if ($('#'+add_id)) element.push($('#'+add_id).val());

                   filters.push(element);
               }
               query_dict[f] = filters;
            }
        }
        console.log(query_dict);
        console.log(fields_arr);
    };

     $(document).on('click', '.t1', function(event) {
             filter_name = $(this).attr('data-filtername')
             filter_id = $(this).attr('data-id')
             $('#operationConfirmFilterName').text(filter_name);
             $('#operationConfirmId').val(filter_id);
             $('#operationConfirmType').val('1');
             $('#modalDeleteConfirm').modal('show');
    });


     $(document).on('click', '#buttonOperationConfirmed', function(event) {
        operation_id = $('#operationConfirmId').val();
        operation_type = $('#operationConfirmType').val();

        //Delete filter
        if (operation_type === '1') {
             $.ajax({
                type: 'POST',
                url: "{% url 'data:filter_delete' %}",
                async: false,
                data: {
                    'id' : operation_id,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}'
                },
            });
        };
        ta_flt_table.ajax.reload( null, true );
    });

      $(document).on('click', '.t2', function(event) {
        filter_name = $(this).attr('data-filtername')
        filter_id = $(this).attr('data-id')
        $('#inputFilterName').text( filter_name );
        $('#saveConfirmId').val( filter_id );
        $('#saveConfirmType').val( '1' );
        $('#modalFilterSave').modal('show');
    });

    $(document).on('click', '#data_save_button', function(event) {
        $('#modalFilterSave').modal('show');
    });

     $(document).on('click', '#btn_filter_save', function(event) {
        filter_name = $('#inputFilterName').val();
        make_request_data ();
        $.ajax({
            type: 'POST',
            url: '{% url 'data:filter_save' %}',
            async: false,
            //traditional: true,
            data: {
                'name' : filter_name,
                'filters' : JSON.stringify(query_dict),
                'fields' : JSON.stringify(fields_arr),
                'csrfmiddlewaretoken' : '{{ csrf_token }}'
            },
            success: function (data) {
            },
            error: function (xhr, str) {
                    alert('Error loading data. ' + str);
            }
        });
        $('#modalFilterSave').modal('hide');
        ta_flt_table.ajax.reload( null, true );

    });

    $(document).on('click', '#data_clear_button', function(event) {
        for (var idx in all_fields) {
            field_name = all_fields[idx];
            cnt = flt_counts[field_name];
            for (var i = 1; i < cnt; i++) {
                ig = '#input-group-' + field_name + '-' + i;
                $(ig).remove();
            };

            input_element = $('#input-' + field_name + '-0' );
            input_element.val(null);
            if (input_element.hasClass('select-2')) { input_element.trigger('change'); };

            $('#add-' + field_name + '-0' ).val(null);

            flt_counts[field_name] = 1;
            $('#' + field_name + '_filter').removeClass('active');
            $('#' + field_name + '_check').addClass('active');
        }
    });

    $(document).on('click', '#data_load_button', function(event) {
        make_request_data();

        $.ajax({
           type: "POST",
           url: "{% url 'data:dl' %}",
            data: {
                'filters' : JSON.stringify(query_dict),
                'fields' : JSON.stringify(fields_arr),
                'csrfmiddlewaretoken' : '{{ csrf_token }}'
            },
           traditional: true,
           //contentType: "application/json",
           //dataType: "text",
           success: function (data) {
              var url = data.download_url;
              window.location = url;
           },
        });
    });

    //ToolTip initialize
    $(function () { $('[data-toggle="tooltip"]').tooltip() })

 </script>