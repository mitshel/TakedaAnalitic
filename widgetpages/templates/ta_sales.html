{% extends "ta_layout.html" %}
{% load staticfiles %}
{% load i18n %}

{% block page %}

	<script type="text/javascript" src="{% static 'chartjs\Chart.bundle.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'chartjs\utils.js' %}"></script>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>

	<div class="col-12">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<script>
		//var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
		var config = {
			type: 'line',
			data: {
				labels: [{% for y in year %}{{ y.PlanTYear }}{% if not forloop.last %},{% endif %}{% endfor %}],
				datasets: [
				    {% regroup pivot by market_name as market_list %}
                    {% for market in market_list %}
				    {
                        label: '{{ market.grouper }}',
                        backgroundColor: window.listColors[{{ forloop.counter0 }}],
                        borderColor: window.listColors[{{ forloop.counter0 }}],
                        data: [
                            {% for m in market.list %}{ x:{{ m.PlanTYear }}, y:{{ m.product_cost_sum|floatformat:"0" }} }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ],
                        fill: false,
                        tension: 0
				    }{% if not forloop.last %},{% endif %}
                {% endfor %}
                ]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'График продаж по рынку'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Год'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Стоимость продукта (суммарно по годам)'
						}
					}]
				}
			}
		};

		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
		};

		function ChartsUpdate(data) {
		    labels_data = []
            data.year_active.forEach(function(year_active) {
               labels_data.push(year_active.PlanTYear)
            });
		    config.data.labels = labels_data;
		    config.data.datasets.forEach(function(dataset) {
		        chart_data = [];
                for (var i in data.pivot) {
                    if (data.pivot[i].market_name==dataset.label) {
                        chart_data.push({x:data.pivot[i].PlanTYear,y:data.pivot[i].product_cost_sum})
                    }
                }
				dataset.data = chart_data;
			});

			window.myLine.update();
        }

	</script>

{%  endblock %}