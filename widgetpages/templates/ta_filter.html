<style>
.btn-primary:not(:disabled):not(.disabled).active, .btn-primary:not(:disabled):not(.disabled):active, .show > .btn-primary.dropdown-toggle {
    color: #fff;
    background-color: #003090;
    border-color: #005cbf;
}

.btn-secondary:not(:disabled):not(.disabled).active, .btn-secondary:not(:disabled):not(.disabled):active, .show > .btn-secondary.dropdown-toggle {
    color: #fff;
    background-color: #007bff;
    border-color: #005cbf;
}
#entityTable tr {
    font-size: 0.9rem;
    font-weight: 400;
    line-height: 0.9rem;
}
.buttons-select-all, .buttons-select-none {
    line-height: 1; !important;
}

</style>
  <div class="card">
    <div class="card-header" id="headingOne" style="padding-top:0.2rem;padding-bottom:0.2rem;">
      <h5 class="mb-0">
        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Таргет
        </button>
      </h5>
    </div>

    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
      <div class="card-body">
            <form id="empl_form" method="post" action="{% url 'widgetpages:f_emplsupd' %}">
             {% csrf_token %}
              {% for t in target %}
                <button type="button" id='empl_{{ t.id }}' data-id="{{ t.id }}" class="btn btn-secondary btn-sm active inline" data-toggle="button" aria-pressed="false" autocomplete="off" style="margin-top:2px">{{ t.name }}</button>
              {% endfor %}
            </form>
          </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header" id="headingTwo" style="padding-top:0.2rem;padding-bottom:0.2rem;">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
          Рынок
        </button>
      </h5>
    </div>
    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo">
      <div class="card-body">
              {% for m in market %}
                <button type="button" id='market_{{ m.market }}' data-id="{{ m.market }}" class="btn btn-secondary active btn-sm inline" data-toggle="button" aria-pressed="false" autocomplete="off" style="margin-top:2px">{{ m.market }}</button>
              {% endfor %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header" id="headingThree" style="padding-top:0.2rem;padding-bottom:0.2rem;">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
          Год поставки
        </button>
      </h5>
    </div>
    <div id="collapseThree" class="collapse" aria-labelledby="headingThree">
      <div class="card-body">
              {% for y in year %}
                <button type="button" id='year_{{ y.delivery_year }}' data-id="{{ y.delivery_year }}" class="btn btn-secondary active btn-sm inline" data-toggle="button" aria-pressed="false" autocomplete="off" style="margin-top:2px">{{ y.delivery_year }}</button>
              {% endfor %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header" id="headingFour" style="padding-top:0.2rem;padding-bottom:0.2rem;">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">
          Грузополучатель
        </button>
      </h5>
    </div>
    <div id="collapseFour" class="collapse" aria-labelledby="headingFour">
      <div class="card-body">
              <table class="table table-sm table-hover display w-100" width="100%" id="entityTable">
              </table>
      </div>
    </div>
  </div>

<script type="text/javascript">

var entityes = [
                    {% for e in entity %} {DT_RowId:'entity_id_{{ e.id }}', entity:'{{ e.entity }}', inn:'{{ e.inn }}', disabled:'0' } {% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
var table = $('#entityTable').DataTable({
                "dom": '<"row"<f><l><B><r>><"row"<"col-12"t>><"row"<"col-12"p><"col-12"i>>',
                buttons: [
                    'selectAll',
                    'selectNone',
                ],
                ordering:  true,
                "pageLength": 10,
                "columnDefs": [
                    {
                        "targets": [ 1 ],
                        "visible": false,
                        "searchable": true
                    },
                    {
                        "targets": [ 2 ],
                        "visible": false,
                        "searchable": false
                    }
                ],
                data: entityes,
                columns: [
                { data: 'entity' },
                { data: 'inn' },
                { data: 'disabled' }
                ],
//                "rowCallback": function( row, data ) {
//                    $(row).attr('data-id',data.id);
//                    $(row).addClass('entity');
//                    $('td:eq(1)', row).attr('style','width:100%;');
//                    $('td:eq(1)', row).html('<span title="'+data.id+' '+data.entity+'">'+data.entity+'</span>');
//                },
                "language": {
                              "processing": "Подождите...",
                              "search": "Поиск:",
                              "lengthMenu": "&nbsp;&nbsp;_MENU_&nbsp;&nbsp;",
                              "info": "Записи с _START_ до _END_ из _TOTAL_ записей",
                              "infoEmpty": "Записи с 0 до 0 из 0 записей",
                              "infoFiltered": "(отфильтровано из _MAX_ записей)",
                              "infoPostFix": "",
                              "loadingRecords": "Загрузка записей...",
                              "zeroRecords": "Записи отсутствуют.",
                              "emptyTable": "В таблице отсутствуют данные",
                              "paginate": {
                                "first": "Первая",
                                "previous": "Пред.",
                                "next": "След.",
                                "last": "Посл."
                              },
                              "aria": {
                                "sortAscending": ": активировать для сортировки столбца по возрастанию",
                                "sortDescending": ": активировать для сортировки столбца по убыванию"
                              },
                              "buttons": {
                                "selectAll": "Выбрать все",
                                "selectNone": "Снять выбор"
                              }
                            }
            });

$(table.column(0).header()).html('<b>ЛПУ</b>');
table.rows().select();


$('#entityTable tbody').on( 'click', 'tr', function () {
    $(this).toggleClass('selected');
} );

$.fn.dataTable.ext.search.push(
    function( settings, data, DataIndex ) {
        var disabled = settings.aoData[DataIndex]._aData.disabled;
        if (disabled == '0')
            return true
        else
            return false;
    }
);

function processAjaxData(data) {
    var year_list = data.year_active;
    var market_list = data.market_active;
    var entity_list = data.lpu;
    var i = 0;

    $('button[id^=year_]').addClass('disabled');
    for (var i in year_list) $('#year_'+year_list[i].delivery_year).removeClass('disabled');

    $('button[id^=market_]').addClass('disabled');
    for (var i in market_list) $('#market_'+market_list[i].market).removeClass('disabled');

    table.data().each( function (d) {
        d.disabled = '1';
    } );

    for (var i in entity_list) {
        d = table.row('#entity_id_'+entity_list[i].id);
        if ( d && d.data() ) d.data().disabled = '0';
    }

    table.draw();

    ChartsUpdate(data);
}

$(document).on('click', 'button[id^=empl_], button[id^=year_], button[id^=market_], #entityTable tbody, .buttons-select-all, .buttons-select-none', function() {
    action_url = $('#empl_form').attr("action");

    var arr = [];
    $('button[id^=empl_].active').each(function() {
        arr.push($(this).attr('data-id'))
    });
    var empl_active = arr.join(',');

    var arr = [];
    $('button[id^=market_].active').each(function() {
        arr.push($(this).attr('data-id'))
    });
    var market_active = arr.join(',');

    var arr = [];
    $('button[id^=year_].active').each(function() {
        arr.push($(this).attr('data-id'))
    });
    var year_active = arr.join(',');

    arr = [];
    table.rows('.selected').every( function ( rowIdx, tableLoop, rowLoop ) {
        if (this.data().disabled==0) arr.push(this.data().inn);
    } );
    var entity_active = arr.join(',');

    $.ajax({
        type: 'POST',
        url: action_url,
        data: {'empl_active' : empl_active,
               'entity_active': entity_active,
               'year_active': year_active,
               'market_active':market_active,
               'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (data) {
            //alert('Load was performed.');
            processAjaxData(data) ;
        },
        error: function (xhr, str) {
            alert('Error loading data. '+str);
        }
    });
    return true;
});

</script>